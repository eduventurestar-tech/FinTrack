<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack BWP - Mobile Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        /* MOBILE-FIRST STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #f5f7fa;
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* Auth Modal */
        .auth-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .auth-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .auth-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .auth-tab.active {
            color: #4361ee;
            border-bottom: 2px solid #4361ee;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .auth-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .forgot-password {
            color: #4361ee;
            text-decoration: none;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .auth-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
        }

        .auth-switch {
            color: #4361ee;
            cursor: pointer;
            text-decoration: underline;
        }

        .error-message {
            color: #f72585;
            font-size: 0.8rem;
            margin: -8px 0 12px 0;
            display: none;
        }

        /* Main App Container */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            display: none;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
            color: #4361ee;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-menu {
            position: relative;
        }

        .user-btn {
            background: #4361ee;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 140px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 1;
            overflow: hidden;
        }

        .user-dropdown a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: #333;
            font-size: 0.9rem;
        }

        .user-menu:hover .user-dropdown {
            display: block;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 500px) {
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 18px;
        }
        
        .card.income {
            border-top: 4px solid #4cc9f0;
        }
        
        .card.expense {
            border-top: 4px solid #f72585;
        }
        
        .card.balance {
            border-top: 4px solid #4361ee;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .card-change {
            font-size: 0.8rem;
            color: #666;
        }
        
        .positive {
            color: #4cc9f0;
        }
        
        .negative {
            color: #f72585;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .form-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #4361ee;
            color: white;
        }
        
        .btn-block {
            display: block;
            width: 100%;
            text-align: center;
        }

        /* Transactions Container */
        .transactions-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 18px;
        }
        
        .book-management {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .book-btn {
            padding: 8px 12px;
            border-radius: 8px;
            background: #4361ee;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .active-book {
            background: #3a0ca3;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #4361ee;
        }
        
        #new-book-name {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .transactions-list {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .transaction-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .income-icon {
            background: rgba(76, 201, 240, 0.15);
            color: #4cc9f0;
        }
        
        .expense-icon {
            background: rgba(247, 37, 133, 0.15);
            color: #f72585;
        }
        
        .transaction-details {
            min-width: 0;
        }
        
        .transaction-details h3 {
            font-size: 1rem;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .transaction-details p {
            color: #666;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 1rem;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .income-amount {
            color: #4cc9f0;
        }
        
        .expense-amount {
            color: #f72585;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 0;
            color: #666;
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ddd;
        }
        
        .empty-state p {
            font-size: 1rem;
        }
        
        .last-updated {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 8px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        
        /* Management Panel */
        .management-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 600px) {
            .management-panel {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .management-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 15px;
        }
        
        .management-card h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4361ee;
            font-size: 1rem;
        }
        
        .item-list {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .item-list div {
            padding: 6px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }
        
        .delete-item {
            color: #f72585;
            cursor: pointer;
        }
        
        .add-item-form {
            display: flex;
            gap: 8px;
        }
        
        .add-item-form input {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .add-item-btn {
            padding: 8px 12px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.8rem;
            margin-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        /* Forgot Password Modal */
        .forgot-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .forgot-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .forgot-container h3 {
            margin-bottom: 15px;
            color: #4361ee;
        }
        
        .forgot-container p {
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
            </div>
            
            <div id="loginForm" class="auth-form active">
                <div id="loginError" class="error-message"></div>
                <input type="text" id="loginEmail" placeholder="Email" autocapitalize="off">
                <input type="password" id="loginPassword" placeholder="Password">
                <div class="auth-options">
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Remember me</label>
                    </div>
                    <a href="#" class="forgot-password" onclick="showForgotPassword()">Forgot password?</a>
                </div>
                <button class="auth-btn" onclick="login()">Login</button>
                <div class="auth-footer">
                    Don't have an account? <span class="auth-switch" onclick="switchAuthTab('signup')">Sign up</span>
                </div>
            </div>
            
            <div id="signupForm" class="auth-form">
                <div id="signupError" class="error-message"></div>
                <input type="text" id="signupName" placeholder="Full Name">
                <input type="text" id="signupEmail" placeholder="Email" autocapitalize="off">
                <input type="password" id="signupPassword" placeholder="Password (min 6 chars)">
                <input type="password" id="signupConfirm" placeholder="Confirm Password">
                <button class="auth-btn" onclick="signup()">Create Account</button>
                <div class="auth-footer">
                    Already have an account? <span class="auth-switch" onclick="switchAuthTab('login')">Login</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotModal" class="forgot-modal">
        <div class="forgot-container">
            <button class="close-btn" onclick="hideForgotPassword()">&times;</button>
            <h3><i class="fas fa-key"></i> Reset Password</h3>
            <p>Enter your email address to receive a password reset link.</p>
            <div id="forgotError" class="error-message"></div>
            <input type="email" id="forgotEmail" placeholder="Your email address">
            <button class="auth-btn" onclick="sendResetLink()">Send Reset Link</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="container" id="appContainer">
        <header>
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <h1>FinTrack BWP</h1>
            </div>
            <div class="user-menu">
                <button class="user-btn" id="userBtn">
                    <i class="fas fa-user"></i>
                    <span id="userName">User</span>
                </button>
                <div class="user-dropdown">
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </header>
        
        <div class="summary-cards">
            <div class="card income">
                <div class="card-title">
                    <i class="fas fa-arrow-down"></i>
                    <span>Total Income</span>
                </div>
                <div class="card-value" id="income-total">P0.00</div>
                <div class="card-change">
                    <span class="positive">+0% from last month</span>
                </div>
            </div>
            
            <div class="card expense">
                <div class="card-title">
                    <i class="fas fa-arrow-up"></i>
                    <span>Total Expenses</span>
                </div>
                <div class="card-value" id="expense-total">P0.00</div>
                <div class="card-change">
                    <span class="negative">-0% from last month</span>
                </div>
            </div>
            
            <div class="card balance">
                <div class="card-title">
                    <i class="fas fa-piggy-bank"></i>
                    <span>Current Balance</span>
                </div>
                <div class="card-value" id="balance-total">P0.00</div>
                <div class="card-change">
                    <span>Net cash flow</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-container">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    Add Transaction
                </h2>
                
                <form id="transaction-form">
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" placeholder="e.g. Groceries, Salary" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Amount (Pula)</label>
                        <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Transaction Type</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="income" name="type" value="income" checked>
                                <label for="income">Income</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="expense" name="type" value="expense">
                                <label for="expense">Expense</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" required>
                            <!-- Populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-mode">Payment Mode</label>
                        <select id="payment-mode" required>
                            <!-- Populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-plus"></i>
                        Add Transaction
                    </button>
                </form>
            </div>
            
            <div class="form-container">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Expense Distribution
                </h2>
                <div class="chart-container">
                    <canvas id="expense-chart"></canvas>
                </div>
                
                <h2 class="section-title" style="margin-top: 20px;">
                    <i class="fas fa-chart-line"></i>
                    Income vs Expenses
                </h2>
                <div class="chart-container">
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Category and Payment Mode Management -->
        <div class="management-panel">
            <div class="management-card">
                <h3><i class="fas fa-tags"></i> Manage Categories</h3>
                <div class="item-list" id="category-list">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="add-item-form">
                    <input type="text" id="new-category" placeholder="New category name">
                    <button class="add-item-btn" onclick="addCategory()">Add</button>
                </div>
            </div>
            
            <div class="management-card">
                <h3><i class="fas fa-credit-card"></i> Manage Payment Modes</h3>
                <div class="item-list" id="payment-mode-list">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="add-item-form">
                    <input type="text" id="new-payment-mode" placeholder="New payment mode">
                    <button class="add-item-btn" onclick="addPaymentMode()">Add</button>
                </div>
            </div>
        </div>
        
        <div class="transactions-container">
            <div class="book-management">
                <!-- Populated by JavaScript -->
                <input type="text" id="new-book-name" placeholder="New book name">
                <button class="book-btn" onclick="createNewBook()">
                    <i class="fas fa-plus"></i> Create Book
                </button>
            </div>
            
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                Recent Transactions
                <span class="last-updated">
                    <i class="fas fa-clock"></i>
                    <span id="last-updated-time">Never updated</span>
                </span>
            </h2>
            
            <div class="transactions-list" id="transactions-list">
                <div class="empty-state">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <p>No transactions yet. Add your first transaction!</p>
                </div>
            </div>
            
            <div class="export-options">
                <button class="export-btn" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="export-btn" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
        
        <footer>
            <p>Â© <span id="current-year"></span> FinTrack BWP - All data stored in your browser</p>
        </footer>
    </div>

    <script>
        // ================= AUTHENTICATION SYSTEM =================
        const authSystem = {
            users: JSON.parse(localStorage.getItem('finTrackUsers')) || [],
            currentUser: null,
            
            init() {
                // Check if user is already logged in from remember me
                const rememberedUser = localStorage.getItem('finTrackRememberedUser');
                if (rememberedUser) {
                    try {
                        const { email, password } = JSON.parse(rememberedUser);
                        const user = this.users.find(u => u.email === email && u.password === password);
                        if (user) {
                            this.loginUser(user);
                            document.getElementById('rememberMe').checked = true;
                            return;
                        }
                    } catch (e) {
                        console.error("Error loading remembered user:", e);
                    }
                }
                
                // Check normal login
                const loggedInUser = localStorage.getItem('finTrackCurrentUser');
                if (loggedInUser) {
                    try {
                        this.currentUser = JSON.parse(loggedInUser);
                        this.showApp();
                        financialTracker.loadUserData();
                    } catch (e) {
                        this.showAuthModal();
                    }
                } else {
                    this.showAuthModal();
                }
                
                // Add test user if none exists
                if (this.users.length === 0) {
                    this.users.push({
                        id: 'demo-user',
                        name: 'Demo User',
                        email: 'demo@fintrack.com',
                        password: 'demo123',
                        createdAt: new Date().toISOString()
                    });
                    localStorage.setItem('finTrackUsers', JSON.stringify(this.users));
                }
            },
            
            showAuthModal() {
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                this.clearErrors();
            },
            
            hideAuthModal() {
                document.getElementById('authModal').style.display = 'none';
            },
            
            showApp() {
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userName').textContent = this.currentUser.name;
                
                // Set current year in footer
                document.getElementById('current-year').textContent = new Date().getFullYear();
            },
            
            clearErrors() {
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('signupError').style.display = 'none';
                document.getElementById('forgotError').style.display = 'none';
            },
            
            showError(form, message) {
                const errorEl = document.getElementById(`${form}Error`);
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            },
            
            validateEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            },
            
            signup() {
                this.clearErrors();
                
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim().toLowerCase();
                const password = document.getElementById('signupPassword').value;
                const confirm = document.getElementById('signupConfirm').value;
                
                // Validation
                if (!name || !email || !password || !confirm) {
                    this.showError('signup', 'Please fill all fields');
                    return;
                }
                
                if (!this.validateEmail(email)) {
                    this.showError('signup', 'Please enter a valid email');
                    return;
                }
                
                if (password.length < 6) {
                    this.showError('signup', 'Password must be at least 6 characters');
                    return;
                }
                
                if (password !== confirm) {
                    this.showError('signup', 'Passwords do not match');
                    return;
                }
                
                if (this.users.some(u => u.email === email)) {
                    this.showError('signup', 'Email already registered');
                    return;
                }
                
                // Create user
                const user = {
                    id: 'user-' + Date.now(),
                    name,
                    email,
                    password,
                    createdAt: new Date().toISOString()
                };
                
                this.users.push(user);
                localStorage.setItem('finTrackUsers', JSON.stringify(this.users));
                
                // Auto-login
                this.loginUser(user);
            },
            
            login() {
                this.clearErrors();
                
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                if (!email || !password) {
                    this.showError('login', 'Please fill all fields');
                    return;
                }
                
                const user = this.users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Handle remember me
                    if (rememberMe) {
                        localStorage.setItem('finTrackRememberedUser', JSON.stringify({ email, password }));
                    } else {
                        localStorage.removeItem('finTrackRememberedUser');
                    }
                    
                    this.loginUser(user);
                } else {
                    this.showError('login', 'Invalid email or password');
                }
            },
            
            loginUser(user) {
                this.currentUser = user;
                localStorage.setItem('finTrackCurrentUser', JSON.stringify(user));
                this.hideAuthModal();
                this.showApp();
                financialTracker.loadUserData();
            },
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('finTrackCurrentUser');
                    localStorage.removeItem('finTrackRememberedUser');
                    this.currentUser = null;
                    this.showAuthModal();
                    
                    // Clear form inputs
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('rememberMe').checked = false;
                }
            },
            
            sendResetLink() {
                const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
                
                if (!email) {
                    this.showError('forgot', 'Please enter your email');
                    return;
                }
                
                if (!this.validateEmail(email)) {
                    this.showError('forgot', 'Please enter a valid email');
                    return;
                }
                
                const userExists = this.users.some(u => u.email === email);
                if (!userExists) {
                    this.showError('forgot', 'No account found with this email');
                    return;
                }
                
                // In a real app, you would send an email here
                // For this demo, we'll just show a success message
                alert(`Password reset link sent to ${email} (simulated)`);
                this.hideForgotPassword();
            },
            
            switchAuthTab(tab) {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                
                document.querySelector(`.auth-tab[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
                document.getElementById(`${tab}Form`).classList.add('active');
                this.clearErrors();
            },
            
            showForgotPassword() {
                document.getElementById('forgotModal').style.display = 'flex';
                this.clearErrors();
            },
            
            hideForgotPassword() {
                document.getElementById('forgotModal').style.display = 'none';
                document.getElementById('forgotEmail').value = '';
            }
        };

        // ================= FINANCIAL TRACKER SYSTEM =================
        const financialTracker = {
            // Initialize charts
            expenseChart: null,
            comparisonChart: null,
            
            initCharts() {
                this.expenseChart = new Chart(
                    document.getElementById('expense-chart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    '#4cc9f0',
                                    '#f72585',
                                    '#f8961e',
                                    '#7209b7',
                                    '#3a0ca3',
                                    '#4361ee',
                                    '#2ec4b6',
                                    '#e71d36',
                                    '#ff9f1c',
                                    '#011627'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                title: {
                                    display: true,
                                    text: 'Expense Categories'
                                }
                            }
                        }
                    }
                );

                this.comparisonChart = new Chart(
                    document.getElementById('comparison-chart'),
                    {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                            datasets: [
                                {
                                    label: 'Income',
                                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                                    backgroundColor: '#4cc9f0',
                                },
                                {
                                    label: 'Expenses',
                                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                                    backgroundColor: '#f72585',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Monthly Comparison'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );
            },
            
            // Load user data
            loadUserData() {
                const userData = JSON.parse(localStorage.getItem(`finTrackData_${authSystem.currentUser.id}`)) || {
                    books: {
                        main: {
                            name: "Main Book",
                            transactions: [],
                            lastUpdated: null
                        }
                    },
                    currentBook: 'main',
                    settings: {
                        categories: [
                            "Salary", "Business", "Investment", 
                            "Food & Dining", "Shopping", "Transportation",
                            "Housing", "Utilities", "Entertainment", 
                            "Health & Fitness", "Other"
                        ],
                        paymentModes: [
                            "Cash", "Bank Transfer", "Debit Card",
                            "Credit Card", "Mobile Money", "Cheque"
                        ]
                    }
                };
                
                // Initialize charts if not already done
                if (!this.expenseChart) {
                    this.initCharts();
                }
                
                // Initialize the financial tracker
                this.initFinancialTracker(userData);
            },
            
            // Initialize the financial tracker with user data
            initFinancialTracker(userData) {
                this.data = userData;
                
                // Initialize dropdowns
                this.initDropdowns();
                
                // Set default date to today
                document.getElementById('date').valueAsDate = new Date();
                
                // Render UI
                this.renderBookButtons();
                this.renderManagementLists();
                this.renderTransactions();
                this.updateSummary();
                this.updateCharts();
                this.updateLastUpdated();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Add sample data if empty
                if (this.data.books[this.data.currentBook].transactions.length === 0) {
                    this.addSampleData();
                }
            },
            
            // Format currency as BWP
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-BW', {
                    style: 'currency',
                    currency: 'BWP',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            },
            
            // Initialize dropdown menus
            initDropdowns() {
                const categorySelect = document.getElementById('category');
                const paymentModeSelect = document.getElementById('payment-mode');
                
                // Clear existing options
                categorySelect.innerHTML = '';
                paymentModeSelect.innerHTML = '';
                
                // Add default option
                categorySelect.appendChild(new Option("Select a category", ""));
                paymentModeSelect.appendChild(new Option("Select payment mode", ""));
                
                // Add categories
                this.data.settings.categories.forEach(category => {
                    categorySelect.appendChild(new Option(category, category));
                });
                
                // Add payment modes
                this.data.settings.paymentModes.forEach(mode => {
                    paymentModeSelect.appendChild(new Option(mode, mode));
                });
            },
            
            // Save user data
            saveData() {
                this.data.books[this.data.currentBook].lastUpdated = new Date().toISOString();
                localStorage.setItem(`finTrackData_${authSystem.currentUser.id}`, JSON.stringify(this.data));
                this.updateLastUpdated();
            },
            
            // Update last updated time display
            updateLastUpdated() {
                const lastUpdated = this.data.books[this.data.currentBook].lastUpdated;
                const element = document.getElementById('last-updated-time');
                
                if (lastUpdated) {
                    const date = new Date(lastUpdated);
                    element.textContent = date.toLocaleString('en-BW');
                } else {
                    element.textContent = "Never updated";
                }
            },
            
            // Add sample data
            addSampleData() {
                const book = this.data.books[this.data.currentBook];
                
                book.transactions = [
                    {
                        id: Date.now(),
                        description: "Monthly Salary",
                        amount: 12000,
                        type: "income",
                        category: "Salary",
                        paymentMode: "Bank Transfer",
                        date: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: Date.now() + 1,
                        description: "Supermarket Shopping",
                        amount: 450.75,
                        type: "expense",
                        category: "Food & Dining",
                        paymentMode: "Debit Card",
                        date: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: Date.now() + 2,
                        description: "Electricity Bill",
                        amount: 320.50,
                        type: "expense",
                        category: "Utilities",
                        paymentMode: "Bank Transfer",
                        date: new Date().toISOString().split('T')[0]
                    }
                ];
                
                this.saveData();
                this.renderTransactions();
                this.updateSummary();
                this.updateCharts();
            },
            
            // Setup event listeners
            setupEventListeners() {
                // Transaction form submission
                document.getElementById('transaction-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });
            },
            
            // Add new transaction
            addTransaction() {
                const description = document.getElementById('description').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const type = document.querySelector('input[name="type"]:checked').value;
                const category = document.getElementById('category').value;
                const paymentMode = document.getElementById('payment-mode').value;
                const date = document.getElementById('date').value;
                
                if (!description || isNaN(amount) || !category || !paymentMode || !date) {
                    alert('Please fill all fields');
                    return;
                }
                
                const transaction = {
                    id: Date.now(),
                    description,
                    amount,
                    type,
                    category,
                    paymentMode,
                    date
                };
                
                this.data.books[this.data.currentBook].transactions.push(transaction);
                this.saveData();
                this.renderTransactions();
                this.updateSummary();
                this.updateCharts();
                
                // Reset form
                document.getElementById('transaction-form').reset();
                document.getElementById('date').valueAsDate = new Date();
            },
            
            // Delete transaction
            deleteTransaction(id) {
                if (confirm('Delete this transaction?')) {
                    this.data.books[this.data.currentBook].transactions = 
                        this.data.books[this.data.currentBook].transactions.filter(t => t.id !== id);
                    this.saveData();
                    this.renderTransactions();
                    this.updateSummary();
                    this.updateCharts();
                }
            },
            
            // Render transactions list
            renderTransactions() {
                const container = document.getElementById('transactions-list');
                const transactions = this.data.books[this.data.currentBook].transactions;
                
                if (transactions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <p>No transactions yet. Add your first transaction!</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = transactions
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${transaction.type}-icon">
                                <i class="fas ${transaction.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div class="transaction-details">
                                <h3>${transaction.description}</h3>
                                <p>
                                    ${transaction.category} â¢ 
                                    ${transaction.paymentMode} â¢ 
                                    ${new Date(transaction.date).toLocaleDateString('en-BW')}
                                </p>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}-amount">
                            ${transaction.type === 'income' ? '+' : '-'}${this.formatCurrency(transaction.amount)}
                        </div>
                        <button class="delete-btn" onclick="financialTracker.deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            },
            
            // Update summary cards
            updateSummary() {
                const transactions = this.data.books[this.data.currentBook].transactions;
                const income = transactions
                    .filter(t => t.type === 'income')
                    .reduce((total, t) => total + t.amount, 0);
                
                const expense = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((total, t) => total + t.amount, 0);
                
                const balance = income - expense;
                
                document.getElementById('income-total').textContent = this.formatCurrency(income);
                document.getElementById('expense-total').textContent = this.formatCurrency(expense);
                document.getElementById('balance-total').textContent = this.formatCurrency(balance);
            },
            
            // Update charts
            updateCharts() {
                // Update expense chart
                const expenseCategories = {};
                const transactions = this.data.books[this.data.currentBook].transactions;
                
                transactions
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    });
                
                this.expenseChart.data.labels = Object.keys(expenseCategories);
                this.expenseChart.data.datasets[0].data = Object.values(expenseCategories);
                this.expenseChart.update();
                
                // Update comparison chart (monthly data)
                const monthlyData = {
                    income: [0, 0, 0, 0, 0, 0, 0, 0], // Jan-Aug
                    expense: [0, 0, 0, 0, 0, 0, 0, 0]
                };
                
                transactions.forEach(t => {
                    const month = new Date(t.date).getMonth();
                    if (month >= 0 && month < 8) {
                        if (t.type === 'income') {
                            monthlyData.income[month] += t.amount;
                        } else {
                            monthlyData.expense[month] += t.amount;
                        }
                    }
                });
                
                this.comparisonChart.data.datasets[0].data = monthlyData.income;
                this.comparisonChart.data.datasets[1].data = monthlyData.expense;
                this.comparisonChart.update();
            },
            
            // Book management functions
            createNewBook() {
                const bookName = document.getElementById('new-book-name').value.trim();
                if (!bookName) {
                    alert('Please enter a book name');
                    return;
                }
                
                const bookId = 'book_' + Date.now();
                this.data.books[bookId] = {
                    name: bookName,
                    transactions: [],
                    lastUpdated: null
                };
                
                document.getElementById('new-book-name').value = '';
                this.saveData();
                this.switchBook(bookId);
            },
            
            switchBook(bookId) {
                this.data.currentBook = bookId;
                this.saveData();
                this.renderBookButtons();
                this.renderTransactions();
                this.updateSummary();
                this.updateCharts();
            },
            
            renderBookButtons() {
                const container = document.querySelector('.book-management');
                container.innerHTML = `
                    <input type="text" id="new-book-name" placeholder="New book name">
                    <button class="book-btn" onclick="financialTracker.createNewBook()">
                        <i class="fas fa-plus"></i> Create Book
                    </button>
                `;
                
                Object.keys(this.data.books).forEach(bookId => {
                    const book = this.data.books[bookId];
                    const btn = document.createElement('button');
                    btn.className = `book-btn ${bookId === this.data.currentBook ? 'active-book' : ''}`;
                    btn.innerHTML = `<i class="fas fa-book"></i> ${book.name}`;
                    btn.onclick = () => this.switchBook(bookId);
                    container.insertBefore(btn, container.firstChild);
                });
            },
            
            // Category and payment mode management
            renderManagementLists() {
                const categoryList = document.getElementById('category-list');
                const paymentModeList = document.getElementById('payment-mode-list');
                
                categoryList.innerHTML = this.data.settings.categories.map(category => `
                    <div>
                        ${category}
                        <span class="delete-item" onclick="financialTracker.removeItem('categories', '${category}')">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </div>
                `).join('');
                
                paymentModeList.innerHTML = this.data.settings.paymentModes.map(mode => `
                    <div>
                        ${mode}
                        <span class="delete-item" onclick="financialTracker.removeItem('paymentModes', '${mode}')">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </div>
                `).join('');
            },
            
            addCategory() {
                const input = document.getElementById('new-category');
                const category = input.value.trim();
                
                if (!category) {
                    alert('Please enter a category name');
                    return;
                }
                
                if (this.data.settings.categories.includes(category)) {
                    alert('This category already exists');
                    return;
                }
                
                this.data.settings.categories.push(category);
                this.saveData();
                this.initDropdowns();
                this.renderManagementLists();
                input.value = '';
            },
            
            addPaymentMode() {
                const input = document.getElementById('new-payment-mode');
                const mode = input.value.trim();
                
                if (!mode) {
                    alert('Please enter a payment mode');
                    return;
                }
                
                if (this.data.settings.paymentModes.includes(mode)) {
                    alert('This payment mode already exists');
                    return;
                }
                
                this.data.settings.paymentModes.push(mode);
                this.saveData();
                this.initDropdowns();
                this.renderManagementLists();
                input.value = '';
            },
            
            removeItem(listType, item) {
                if (confirm(`Remove ${item}? This won't affect existing transactions.`)) {
                    this.data.settings[listType] = this.data.settings[listType].filter(i => i !== item);
                    this.saveData();
                    this.initDropdowns();
                    this.renderManagementLists();
                }
            },
            
            // Export functions
            exportToExcel() {
                const transactions = this.data.books[this.data.currentBook].transactions;
                const bookName = this.data.books[this.data.currentBook].name;
                
                const data = transactions.map(t => ({
                    Date: t.date,
                    Description: t.description,
                    Type: t.type.charAt(0).toUpperCase() + t.type.slice(1),
                    Category: t.category,
                    "Payment Mode": t.paymentMode,
                    Amount: t.amount,
                    "Amount (BWP)": this.formatCurrency(t.amount)
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Transactions");
                
                const fileName = `${bookName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
            },
            
            exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const transactions = this.data.books[this.data.currentBook].transactions;
                const bookName = this.data.books[this.data.currentBook].name;
                
                // Add title
                doc.setFontSize(18);
                doc.text(`${bookName} - Transaction Report`, 14, 20);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleString('en-BW')}`, 14, 30);
                
                // Add summary
                const income = transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expense = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = income - expense;
                
                doc.setFontSize(14);
                doc.text("Summary", 14, 45);
                doc.setFontSize(12);
                doc.text(`Total Income: ${this.formatCurrency(income)}`, 14, 55);
                doc.text(`Total Expenses: ${this.formatCurrency(expense)}`, 14, 65);
                doc.text(`Balance: ${this.formatCurrency(balance)}`, 14, 75);
                
                // Add transactions table
                doc.setFontSize(14);
                doc.text("Transaction Details", 14, 90);
                
                const headers = ["Date", "Description", "Type", "Category", "Amount"];
                const data = transactions.map(t => [
                    new Date(t.date).toLocaleDateString('en-BW'),
                    t.description,
                    t.type.charAt(0).toUpperCase() + t.type.slice(1),
                    t.category,
                    this.formatCurrency(t.amount)
                ]);
                
                doc.autoTable({
                    startY: 95,
                    head: [headers],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [67, 97, 238] }
                });
                
                // Save the PDF
                const fileName = `${bookName.replace(/[^a-z0-9]/gi, '_')}_Report_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
            }
        };

        // ================= INITIALIZE THE APPLICATION =================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize authentication system
            authSystem.init();
            
            // Global functions for HTML onclick handlers
            window.switchAuthTab = (tab) => authSystem.switchAuthTab(tab);
            window.login = () => authSystem.login();
            window.signup = () => authSystem.signup();
            window.logout = () => authSystem.logout();
            window.showForgotPassword = () => authSystem.showForgotPassword();
            window.hideForgotPassword = () => authSystem.hideForgotPassword();
            window.sendResetLink = () => authSystem.sendResetLink();
            
            // Financial tracker functions
            window.financialTracker = financialTracker;
            window.addCategory = () => financialTracker.addCategory();
            window.addPaymentMode = () => financialTracker.addPaymentMode();
            window.createNewBook = () => financialTracker.createNewBook();
            window.exportToExcel = () => financialTracker.exportToExcel();
            window.exportToPDF = () => financialTracker.exportToPDF();
        });
    </script>
</body>
</html>